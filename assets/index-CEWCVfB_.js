import*as s from"https://unpkg.com/three@0.160.1/build/three.module.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))c(o);new MutationObserver(o=>{for(const l of o)if(l.type==="childList")for(const u of l.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&c(u)}).observe(document,{childList:!0,subtree:!0});function n(o){const l={};return o.integrity&&(l.integrity=o.integrity),o.referrerPolicy&&(l.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?l.credentials="include":o.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function c(o){if(o.ep)return;o.ep=!0;const l=n(o);fetch(o.href,l)}})();const Q=[9127187,10578751,12092762,16750592],p={X:50,Y:25,Z:50},G=3.2,K={x:-20,y:G,z:20},be=.008,A=.5,g={wall:13158600,ceiling:16117990,floorDark:6111287,floorLight:9268835,bulb:16777164,wateringCan:2201331,cube:16750592,seed:0,switchPlate:16776960},ge=[{hex:16777215,light:16777215},{hex:16777139,light:16773299},{hex:16757759,light:16738047},{hex:11796403,light:6750054}];function we(e=null){const t=new s.Scene;t.background=new s.Color(1118481);const n=new s.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.5,1e3);e?(n.position.copy(e.cameraPosition),n.rotation.set(e.cameraRotation.x,e.cameraRotation.y,e.cameraRotation.z)):n.position.set(K.x,K.y,K.z);const c=new s.WebGLRenderer({antialias:!0});c.setSize(window.innerWidth,window.innerHeight),c.domElement.style.touchAction="none",document.body.appendChild(c.domElement);const o=new s.AmbientLight(16777215,.05);t.add(o);const l=new s.SpotLight((e==null?void 0:e.spotLightColor)||16773299,e&&!e.isLampOn?0:9.5);l.position.set(0,p.Y,0),l.angle=Math.atan(28.6/p.Y),l.penumbra=.3,l.decay=1,l.distance=60,t.add(l);function u(d=128){const I=document.createElement("canvas");I.width=d,I.height=d;const C=I.getContext("2d");C.fillStyle="#C8C8C8",C.fillRect(0,0,d,d);const y=C.getImageData(0,0,d,d).data;for(let L=0;L<y.length;L+=4){let j=(Math.random()-.5)*15;Math.random()>.8&&(j*=2),y[L]=y[L+1]=y[L+2]=Math.min(255,Math.max(0,200+j)),y[L+3]=255}C.putImageData(new ImageData(y,d,d),0,0);const B=new s.CanvasTexture(I);return B.wrapS=B.wrapT=s.RepeatWrapping,B.repeat.set(6,6),B}const m=u();[{pos:[0,p.Y/2,-50/2],size:[p.X,p.Y,1],color:g.wall},{pos:[0,p.Y/2,p.Z/2],size:[p.X,p.Y,1],color:g.wall},{pos:[-50/2,p.Y/2,0],size:[1,p.Y,p.Z],color:g.wall},{pos:[p.X/2,p.Y/2,0],size:[1,p.Y,p.Z],color:g.wall},{pos:[0,0,0],size:[p.X,1,p.Z],color:g.wall},{pos:[0,p.Y,0],size:[p.X,1,p.Z],color:g.ceiling}].forEach((d,I)=>{const C=new s.BoxGeometry(...d.size),y=I<4?new s.MeshStandardMaterial({color:g.wall,map:m,roughness:.95,metalness:0,side:s.BackSide}):new s.MeshStandardMaterial({color:d.color,roughness:.9,metalness:0,side:s.BackSide}),B=new s.Mesh(C,y);B.position.set(...d.pos),t.add(B)});for(let d=0;d<p.X;d++)for(let I=0;I<p.Z;I++){const C=new s.MeshStandardMaterial({color:(d+I)%2===0?g.floorDark:g.floorLight,roughness:.95,metalness:0}),y=new s.Mesh(new s.PlaneGeometry(1,1),C);y.rotation.x=-Math.PI/2,y.position.set(-50/2+d+.5,.01,-50/2+I+.5),t.add(y)}const a=new s.Mesh(new s.SphereGeometry(2,16,16),new s.MeshBasicMaterial({color:(e==null?void 0:e.bulbColor)||g.bulb}));a.position.set(0,p.Y,0),t.add(a);const r=new s.Mesh(new s.CylinderGeometry(.4,.4,.8,16),new s.MeshStandardMaterial({color:g.wateringCan}));e?(r.position.copy(e.wateringCan.position),r.visible=e.wateringCan.visible):r.position.set(5,.5,0),t.add(r);const h=new s.Mesh(new s.BoxGeometry(1.5,1.5,1.5),new s.MeshStandardMaterial({color:g.cube}));h.position.set(1e3,0,0),h.visible=!1,h.userData={type:"cube",wet:!1,dryStage:3},t.add(h);const w=new s.Mesh(new s.SphereGeometry(.5,8,8),new s.MeshStandardMaterial({color:g.seed}));w.position.set(1e3,0,0),w.visible=!1,w.userData={type:"seed"},t.add(w);const E=new s.MeshStandardMaterial({color:g.switchPlate,emissive:3355392,side:s.DoubleSide}),v=new s.Mesh(new s.PlaneGeometry(.25,.25),E);v.position.set(0,G,-50/2+.51),v.rotation.y=Math.PI,t.add(v);const x=new s.Mesh(new s.BoxGeometry(1,.5,1),E);return x.position.set(0,G,p.Z/2-.51),t.add(x),{scene:t,camera:n,renderer:c,objects:{spotLight:l,bulb:a,wateringCan:r,originalCube:h,originalSeed:w,switchPlate:v,colorTile:x}}}function se(){return Date.now().toString(36)+Math.random().toString(36).substr(2,5)}let M={coins:100,heldObject:null,clones:new Set,isLampOn:!0,cubeUIVisible:!1,wateringCanUIVisible:!1,seedUIVisible:!1};const f=()=>M,xe=()=>M.heldObject,ee=()=>M.clones,X=e=>{M.coins=e},k=e=>{M.heldObject=e},ae=e=>{M.clones.add(e)},Ie=e=>{M.clones.delete(e)},Ce=()=>{M.isLampOn=!M.isLampOn},F=e=>{M.cubeUIVisible=e},Z=e=>{M.wateringCanUIVisible=e},N=e=>{M.seedUIVisible=e},Me=document.getElementById("coinCount"),Ee=document.getElementById("cubeUI"),ve=document.getElementById("wateringCanUI"),Be=document.getElementById("seedUI"),J=document.getElementById("confirmBox"),Oe=document.getElementById("confirmText"),ce=document.getElementById("confirmYes"),le=document.getElementById("confirmNo"),z=document.getElementById("colorPickerUI");let R=!1;function Le(){Me.textContent=f().coins}function q(){Ee.style.display=f().cubeUIVisible?"block":"none",ve.style.display=f().wateringCanUIVisible?"block":"none",Be.style.display=f().seedUIVisible?"block":"none"}function te(e,t,n,c,o){R||(Oe.textContent=e,ce.textContent=t,le.textContent=n,ce.onclick=()=>{c(),J.style.display="none",R=!1},le.onclick=()=>{o(),J.style.display="none",R=!1},J.style.display="block",R=!0)}function ke(e){z.innerHTML="<p>–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç</p>",ge.forEach(t=>{const n=document.createElement("div");n.style.backgroundColor="#"+t.hex.toString(16).padStart(6,"0"),n.onclick=()=>{e(t),z.style.display="none"},z.appendChild(n)}),z.style.display="block"}function De(e,t,n,c){const{wateringCan:o,switchPlate:l,colorTile:u,originalCube:m,originalSeed:b}=n,a=document.querySelector("canvas");let r=null,h=null,w=!1;const E=x=>{r&&clearTimeout(r),r=null,h=null},v=(x,d)=>{r&&clearTimeout(r),h=x,r=setTimeout(()=>{d(),E()},200)};a.addEventListener("pointerdown",x=>{if(!document.getElementById("pauseMenu").style.display.includes("flex")&&!document.getElementById("shopMenu").style.display.includes("flex")&&!w){x.clientX,x.clientY;const d=new s.Raycaster,I=new s.Vector3(0,0,-1).applyQuaternion(e.quaternion);d.set(e.position,I);const C=5,y=[];ee().forEach(P=>{if(P.visible){const T=d.intersectObject(P);T.length&&T[0].distance<=C&&y.push({obj:P,dist:T[0].distance})}});const B=d.intersectObject(o),L=d.intersectObject(l),j=d.intersectObject(u);if(B.length&&B[0].distance<=C&&y.push({obj:o,dist:B[0].distance}),L.length&&L[0].distance<=C&&y.push({obj:l,dist:L[0].distance}),j.length&&j[0].distance<=C&&y.push({obj:u,dist:j[0].distance}),y.length===0)return E();y.sort((P,T)=>P.dist-T.dist);const O=y[0].obj;h!==O&&E(),O===u?(w=!0,c("colorPicker")):O===l?(Ce(),c("lamp")):O===o&&f().heldObject!==o&&f().heldObject===null?v(O,()=>{k(o),o.visible=!1,c("pickup",o)}):ee().has(O)&&f().heldObject!==O&&f().heldObject===null&&v(O,()=>{k(O),O.visible=!1,c("pickup",O)})}}),a.addEventListener("pointermove",E),a.addEventListener("pointerup",E),a.addEventListener("pointercancel",E)}const U=document.getElementById("shopContent");function re(e,t,n,c,o,l){U.innerHTML="",[{id:"cube",name:"–ö—É–±",icon:"üüß",price:10},{id:"seed",name:"–°–µ–º–µ—á–∫–æ",icon:"‚ö´",price:10}].forEach(m=>{const b=document.createElement("div");b.className="shopItem",b.innerHTML=`<div class="itemIcon">${m.icon}</div><div class="itemName">${m.name}<br/>${m.price} –º–æ–Ω–µ—Ç</div>`,b.onclick=()=>{te(`–ö—É–ø–∏—Ç—å ${m.name} –∑–∞ ${m.price} –º–æ–Ω–µ—Ç?`,"–î–∞","–ù–µ—Ç",()=>{if(f().coins>=m.price){o();let a;m.id==="cube"?(a=n.clone(),a.material=n.material.clone(),a.userData={...n.userData,isClone:!0,cloneId:se()}):(a=c.clone(),a.material=c.material.clone(),a.userData={...c.userData,isClone:!0,cloneId:se()});const r=new THREE.Vector3(0,-.3,-1.2).applyQuaternion(t.quaternion);a.position.copy(t.position).add(r),a.visible=!0,e.add(a),l(a),k(a),X(f().coins-m.price)}else te("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!","OK","",()=>{},()=>{})},()=>{})},U.appendChild(b)})}function je(e){U.innerHTML="";const t=xe();if(!t||t==="wateringCan"||!ee().has(t)){U.innerHTML='<div style="color:#aaa;">–ù–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏</div>';return}const n=t.userData.type==="cube"?"–ö—É–±":"–°–µ–º–µ—á–∫–æ",c=document.createElement("div");c.className="shopItem",c.innerHTML=`<div class="itemIcon">${t.userData.type==="cube"?"üüß":"‚ö´"}</div><div class="itemName">${n}<br/>10 –º–æ–Ω–µ—Ç</div>`,c.onclick=()=>{te(`–ü—Ä–æ–¥–∞—Ç—å ${n} –∑–∞ 10 –º–æ–Ω–µ—Ç?`,"–î–∞","–ù–µ—Ç",()=>{e(t),X(f().coins+10)},()=>{})},U.appendChild(c)}function Se(e,t,n,c,o,l,u,m){const{coins:b,heldObject:a,cubeUIVisible:r,wateringCanUIVisible:h,seedUIVisible:w,isLampOn:E}=f(),v=[];m.forEach(d=>{d.userData.type==="cube"?v.push({type:"cube",position:d.position.clone(),wet:d.userData.wet,dryStage:d.userData.dryStage,color:d.material.color.getHex(),cloneId:d.userData.cloneId}):d.userData.type==="seed"&&v.push({type:"seed",position:d.position.clone(),cloneId:d.userData.cloneId})});let x=null;return a&&(a===o?x="wateringCan":m.has(a)&&(x=a.userData.cloneId)),{cameraPosition:t.position.clone(),cameraRotation:{x:t.rotation.x,y:t.rotation.y,z:t.rotation.z},isLampOn:E,spotLightColor:n.color.getHex(),bulbColor:c.material.color.getHex(),wateringCan:{position:o.position.clone(),visible:o.visible},clones:v,heldObjectId:x,cubeUIVisible:r,wateringCanUIVisible:h,seedUIVisible:w,coins:b}}function Pe(e,t,n,c,o,l,u,m,b){return n.position.copy(e.cameraPosition),n.rotation.set(e.cameraRotation.x,e.cameraRotation.y,e.cameraRotation.z),c.intensity=e.isLampOn?9.5:0,c.color.setHex(e.spotLightColor),o.material.color.setHex(e.bulbColor),l.position.copy(e.wateringCan.position),l.visible=e.wateringCan.visible,e.clones.forEach(a=>{let r;a.type==="cube"?(r=u.clone(),r.material=u.material.clone(),r.position.copy(a.position),r.userData={type:"cube",wet:a.wet,dryStage:a.dryStage,cloneId:a.cloneId,isClone:!0},r.material.color.setHex(a.color),t.add(r),b.add(r),a.wet&&a.dryStage<3&&setTimeout(()=>{let h=a.dryStage+1;const w=()=>{if(h>=Q.length){r.userData.wet=!1,r.userData.dryStage=3;return}r.userData.dryStage=h,r.material.color.set(Q[h]),h<Q.length-1?r.userData.wetTimer=setTimeout(()=>{h++,w()},1e4):r.userData.wet=!1};w()},100)):a.type==="seed"&&(r=m.clone(),r.material=m.material.clone(),r.position.copy(a.position),r.userData={type:"seed",cloneId:a.cloneId,isClone:!0},t.add(r),b.add(r))}),e.heldObjectId}const oe=document.getElementById("mainMenu"),Y=document.getElementById("continueBtn"),Te=document.getElementById("playBtn"),Ue=document.getElementById("exitBtn"),W=document.getElementById("pauseBtn"),_=document.getElementById("shopBtn"),ie=document.getElementById("pauseMenu"),de=document.getElementById("shopMenu"),He=document.getElementById("resumeBtn"),Ye=document.getElementById("saveAndExitBtn"),ze=document.getElementById("backToMenuBtn"),Re=document.getElementById("shopBuyBtn"),Ve=document.getElementById("shopSellBtn"),Ge=document.getElementById("shopCloseBtn"),Ae=document.getElementById("debug");let D=!1,$=!1,i=null,V=0,fe=0,Xe={x:0},S={w:!1,a:!1,s:!1,d:!1},me=/Android|iPhone|iPad/i.test(navigator.userAgent),H=null;function ue(){const e=f().heldObject;if(!e||!i)return;const t=new s.Vector3(0,0,-2).applyQuaternion(i.camera.quaternion);let n=i.camera.position.clone().add(t);n.y=e===i.objects.wateringCan?.5:e.userData.type==="cube"?1.5/2:.5,n.x=Math.round(n.x),n.z=Math.round(n.z);const c=p.X/2-A,o=p.Z/2-A;n.x=Math.max(-c,Math.min(c,n.x)),n.z=Math.max(-o,Math.min(o,n.z)),e.position.copy(n),e.visible=!0,k(null),F(!1),Z(!1),N(!1),q()}function $e(e){i&&(i.scene.remove(e),Ie(e),k(null),F(!1),Z(!1),N(!1),q())}function ye(e=null){if($)return;const{scene:t,camera:n,renderer:c,objects:o}=we(e);if(i={scene:t,camera:n,renderer:c,objects:o},e){X(e.coins);const l=Pe(e,t,n,o.spotLight,o.bulb,o.wateringCan,o.originalCube,o.originalSeed,f().clones);l==="wateringCan"?(k(o.wateringCan),Z(!0)):l&&f().clones.forEach(u=>{u.userData.cloneId===l&&(k(u),u.userData.type==="cube"?F(!0):u.userData.type==="seed"&&N(!0))})}else X(100);Le(),q(),De(n,t,o,Fe),Re.onclick=()=>re(t,n,o.originalCube,o.originalSeed,ue,ae),Ve.onclick=()=>je($e),Ge.onclick=()=>{de.style.display="none",D=!0},_.onclick=()=>{D=!1,de.style.display="flex",re(t,n,o.originalCube,o.originalSeed,ue,ae)},ne(0),$=!0}function Fe(e,t){e==="lamp"?i.objects.spotLight.intensity=f().isLampOn?9.5:0:e==="colorPicker"?ke(n=>{i.objects.spotLight.color.set(n.light),i.objects.bulb.material.color.set(n.hex)}):e==="pickup"&&(k(t),t===i.objects.wateringCan?Z(!0):t.userData.type==="cube"?F(!0):t.userData.type==="seed"&&N(!0),q())}function Ze(e){let t=0,n=0;me?(t=-0,n=Xe.x):(S.w&&(t+=1),S.s&&(t-=1),S.a&&(n-=1),S.d&&(n+=1));const c=Math.hypot(t,n);if(c>0){t/=c,n/=c;const m=be*Math.pow(c,.4)*e,b=new s.Vector3(-Math.sin(V),0,-Math.cos(V)).normalize(),a=new s.Vector3().crossVectors(b,new s.Vector3(0,1,0)).normalize();i.camera.position.x+=(b.x*t+a.x*n)*m,i.camera.position.z+=(b.z*t+a.z*n)*m}i.camera.position.y=G;const o=p.X/2-A,l=p.Z/2-A;if(i.camera.position.x=Math.max(-o,Math.min(o,i.camera.position.x)),i.camera.position.z=Math.max(-l,Math.min(l,i.camera.position.z)),i.camera.rotation.order="YXZ",i.camera.rotation.y=V,i.camera.rotation.x=fe,f().heldObject){const u=new s.Vector3(0,-.3,-1.2).applyQuaternion(i.camera.quaternion);f().heldObject.position.copy(i.camera.position).add(u),f().heldObject.quaternion.copy(i.camera.quaternion),f().heldObject.rotateY(Math.PI)}f().clones.forEach(u=>{u.visible&&u.userData.type==="cube"?u.position.y=1.5/2:u.visible&&u.userData.type==="seed"&&(u.position.y=.5)}),i.objects.wateringCan.visible&&(i.objects.wateringCan.position.y=.5)}let pe=0;function ne(e){if(!i)return;if(!D){H=requestAnimationFrame(ne);return}const t=e-pe;pe=e,Ze(t);const n=i.camera.position,c=(V*180/Math.PI).toFixed(1),o=(fe*180/Math.PI).toFixed(1);Ae.textContent=`POS: X=${n.x.toFixed(1)}, Y=${n.y.toFixed(1)}, Z=${n.z.toFixed(1)}
LOOK: Yaw=${c}¬∞, Pitch=${o}¬∞
MOBILE: ${me?"–î–∞":"–ù–µ—Ç"} | FPS: ${Math.round(1e3/(t||1))}`,i.renderer.render(i.scene,i.camera),H=requestAnimationFrame(ne)}window.addEventListener("keydown",e=>{S[e.key.toLowerCase()]=["w","a","s","d"].includes(e.key.toLowerCase())});window.addEventListener("keyup",e=>{S[e.key.toLowerCase()]=!1});Te.onclick=()=>{oe.style.display="none",W.style.display="block",_.style.display="block",D=!0,ye(null)};Y.onclick=()=>{const e=localStorage.getItem("savedGameState");e&&(oe.style.display="none",W.style.display="block",_.style.display="block",D=!0,ye(JSON.parse(e)))};Ue.onclick=()=>{confirm("–í—ã–π—Ç–∏?")&&location.reload()};W.onclick=()=>{D=!1,ie.style.display="flex"};He.onclick=()=>{ie.style.display="none",D=!0};Ye.onclick=()=>{if($&&i){const e=Se(i.scene,i.camera,i.objects.spotLight,i.objects.bulb,i.objects.wateringCan,i.objects.originalCube,i.objects.originalSeed,f().clones);localStorage.setItem("savedGameState",JSON.stringify(e)),Y.style.display="block"}he()};ze.onclick=()=>{localStorage.removeItem("savedGameState"),Y.style.display="none",he()};function he(){ie.style.display="none",oe.style.display="block",W.style.display="none",_.style.display="none",D=!1,$=!1,H&&(cancelAnimationFrame(H),H=null),document.querySelectorAll("#cubeUI, #wateringCanUI, #seedUI, #colorPickerUI, #confirmBox, #shopMenu").forEach(e=>e.style.display="none")}localStorage.getItem("savedGameState")?Y.style.display="block":Y.style.display="none";window.addEventListener("resize",()=>{i&&(i.camera.aspect=window.innerWidth/window.innerHeight,i.camera.updateProjectionMatrix(),i.renderer.setSize(window.innerWidth,window.innerHeight))});
